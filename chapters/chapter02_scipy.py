"""
第2章: SciPyによる線形計画法
=============================

この章では、SciPyを使って線形計画問題を解く方法を学びます。
"""

from scipy.optimize import linprog


def print_section(title: str) -> None:
    """セクションタイトルを表示する"""
    print("\n" + "=" * 60)
    print(f" {title}")
    print("=" * 60 + "\n")


def print_result(result, is_maximization: bool = False) -> None:
    """最適化結果を表示する"""
    print(f"ステータス: {result.message}")
    print(f"成功: {result.success}")
    print(f"反復回数: {result.nit}")

    if result.success:
        obj_value = -result.fun if is_maximization else result.fun
        print(f"目的関数の最適値: {obj_value:.4f}")
        print("決定変数の最適値:")
        for i, val in enumerate(result.x):
            print(f"  x{i + 1} = {val:.4f}")
        if hasattr(result, "slack") and len(result.slack) > 0:
            print("スラック変数:")
            for i, val in enumerate(result.slack):
                print(f"  slack{i + 1} = {val:.4f}")


# ============================================================
# 2.1 SciPyの基本
# ============================================================

print_section("2.1 SciPyのlinprog()の基本")

scipy_basics = """
SciPyの linprog() 関数は、以下の形式の線形計画問題を解きます：

  最小化:  c^T * x

  制約条件:
    A_ub * x <= b_ub  （不等式制約）
    A_eq * x = b_eq   （等式制約）
    lb <= x <= ub     （変数の範囲）

【重要な注意点】
1. linprog()は「最小化」のみ対応
   → 最大化したい場合は、目的関数の係数に-1を掛ける

2. 不等式は「<=」のみ対応
   → 「>=」の場合は、両辺に-1を掛けて「<=」に変換

3. 変数のデフォルト範囲は [0, +∞)
"""
print(scipy_basics)


# ============================================================
# 例題1: 基本的な最小化問題
# ============================================================

print_section("例題1: 基本的な最小化問題")

problem1 = """
【問題】
  最小化:  z = 3x + 2y

  制約条件:
    x + y  >= 4
    2x + y >= 6
    x >= 0, y >= 0

【解法】
不等式「>=」を「<=」に変換するため、両辺に-1を掛けます：
    -x - y  <= -4
    -2x - y <= -6
"""
print(problem1)

# 目的関数の係数（最小化なのでそのまま）
c = [3, 2]

# 不等式制約の左辺係数（>=を<=に変換するため-1を掛ける）
A_ub = [
    [-1, -1],  # -x - y <= -4
    [-2, -1],  # -2x - y <= -6
]

# 不等式制約の右辺
b_ub = [-4, -6]

# 最適化実行
result = linprog(c, A_ub=A_ub, b_ub=b_ub, method="highs")

print("【結果】")
print_result(result)


# ============================================================
# 例題2: 最大化問題
# ============================================================

print_section("例題2: 最大化問題")

problem2 = """
【問題】
  最大化:  z = x + 2y

  制約条件:
    2x + y  <= 20
    -4x + 5y <= 10
    -x + 2y >= -2  （注：>=なので変換が必要）
    x >= 0, y >= 0

【解法】
1. 最大化 → 最小化：目的関数の係数に-1を掛ける
   最小化: z' = -x - 2y

2. >=を<=に変換：
   -x + 2y >= -2  →  x - 2y <= 2
"""
print(problem2)

# 目的関数の係数（最大化なので-1を掛ける）
c = [-1, -2]

# 不等式制約の左辺係数
A_ub = [
    [2, 1],  # 2x + y <= 20
    [-4, 5],  # -4x + 5y <= 10
    [1, -2],  # x - 2y <= 2 （変換後）
]

# 不等式制約の右辺
b_ub = [20, 10, 2]

# 最適化実行
result = linprog(c, A_ub=A_ub, b_ub=b_ub, method="highs")

print("【結果】")
print_result(result, is_maximization=True)

print("\n【解釈】")
print("最適解は x≈6.43, y≈7.14 で、最大値は約20.71です。")


# ============================================================
# 例題3: 等式制約を含む問題
# ============================================================

print_section("例題3: 等式制約を含む問題")

problem3 = """
【問題】
  最大化:  z = x + 2y

  制約条件:
    2x + y  <= 20
    -4x + 5y <= 10
    -x + 2y >= -2
    -x + 5y = 15   （等式制約）
    x >= 0, y >= 0
"""
print(problem3)

# 目的関数の係数
c = [-1, -2]

# 不等式制約
A_ub = [
    [2, 1],
    [-4, 5],
    [1, -2],
]
b_ub = [20, 10, 2]

# 等式制約
A_eq = [[-1, 5]]  # -x + 5y = 15
b_eq = [15]

# 最適化実行
result = linprog(c, A_ub=A_ub, b_ub=b_ub, A_eq=A_eq, b_eq=b_eq, method="highs")

print("【結果】")
print_result(result, is_maximization=True)

print("\n【解釈】")
print("等式制約を追加したことで、実行可能領域が線分に制限されました。")
print("最適解は x≈7.73, y≈4.55 で、最大値は約16.82です。")


# ============================================================
# 例題4: リソース配分問題
# ============================================================

print_section("例題4: リソース配分問題（工場の生産計画）")

problem4 = """
【問題】
ある工場で4種類の製品を生産しています。
各製品の利益と資源消費量は以下の通りです：

          利益    人員   原材料A   原材料B
製品1:    $20     1       3         0
製品2:    $12     1       2         1
製品3:    $40     1       1         2
製品4:    $25     1       0         3

制約：
- 1日の総生産量は50個以下（人員制約）
- 原材料Aは100単位まで使用可能
- 原材料Bは90単位まで使用可能

【目標】利益を最大化する生産量を求める
"""
print(problem4)

# 目的関数の係数（最大化なので-1を掛ける）
c = [-20, -12, -40, -25]

# 不等式制約の左辺係数
A_ub = [
    [1, 1, 1, 1],  # 人員制約
    [3, 2, 1, 0],  # 原材料A
    [0, 1, 2, 3],  # 原材料B
]

# 不等式制約の右辺
b_ub = [50, 100, 90]

# 最適化実行
result = linprog(c, A_ub=A_ub, b_ub=b_ub, method="highs")

print("【結果】")
print(f"ステータス: {result.message}")
print(f"最大利益: ${-result.fun:.2f}")
print("\n生産計画:")
products = ["製品1", "製品2", "製品3", "製品4"]
for name, val in zip(products, result.x):
    print(f"  {name}: {val:.2f} 個")

print("\n資源使用状況:")
resources = ["人員", "原材料A", "原材料B"]
for name, slack, limit in zip(resources, result.slack, b_ub):
    used = limit - slack
    print(f"  {name}: {used:.2f} / {limit} (余り: {slack:.2f})")

print("\n【解釈】")
print("最適解は製品1を5個、製品3を45個生産することです。")
print("製品2と製品4は利益率が低いため生産しません。")
print("原材料Bがボトルネックとなっています（全量使用）。")


# ============================================================
# 例題5: 変数の上下限を設定する
# ============================================================

print_section("例題5: 変数の範囲制約")

problem5 = """
【問題】
  最小化:  z = 2x + 3y

  制約条件:
    x + y <= 10
    2 <= x <= 8   （xの範囲）
    1 <= y <= 6   （yの範囲）
"""
print(problem5)

# 目的関数の係数
c = [2, 3]

# 不等式制約
A_ub = [[1, 1]]
b_ub = [10]

# 変数の範囲（下限, 上限）
bounds = [
    (2, 8),  # 2 <= x <= 8
    (1, 6),  # 1 <= y <= 6
]

# 最適化実行
result = linprog(c, A_ub=A_ub, b_ub=b_ub, bounds=bounds, method="highs")

print("【結果】")
print_result(result)

print("\n【解釈】")
print("最小値は x=2, y=1 のとき z=7 です。")


# ============================================================
# 例題6: 輸送問題の簡易版
# ============================================================

print_section("例題6: 輸送問題（簡易版）")

problem6 = """
【問題】
2つの工場（A, B）から2つの店舗（1, 2）へ商品を輸送します。
輸送コストと供給・需要は以下の通りです：

輸送コスト（$/個）:
           店舗1   店舗2
  工場A:    4       6
  工場B:    5       3

供給量: 工場A=50, 工場B=40
需要量: 店舗1=30, 店舗2=60

【決定変数】
x1: 工場A→店舗1
x2: 工場A→店舗2
x3: 工場B→店舗1
x4: 工場B→店舗2

【目標】総輸送コストを最小化
"""
print(problem6)

# 目的関数の係数（輸送コスト）
c = [4, 6, 5, 3]

# 等式制約（供給量と需要量のバランス）
A_eq = [
    [1, 1, 0, 0],  # 工場Aからの出荷量 = 50
    [0, 0, 1, 1],  # 工場Bからの出荷量 = 40
    [1, 0, 1, 0],  # 店舗1への入荷量 = 30
    [0, 1, 0, 1],  # 店舗2への入荷量 = 60
]
b_eq = [50, 40, 30, 60]

# 最適化実行
result = linprog(c, A_eq=A_eq, b_eq=b_eq, method="highs")

print("【結果】")
print(f"ステータス: {result.message}")
print(f"最小輸送コスト: ${result.fun:.2f}")
print("\n輸送計画:")
routes = ["工場A→店舗1", "工場A→店舗2", "工場B→店舗1", "工場B→店舗2"]
for route, val in zip(routes, result.x):
    print(f"  {route}: {val:.0f} 個")


# ============================================================
# まとめ
# ============================================================

print_section("第2章のまとめ")

summary = """
この章で学んだこと：

1. scipy.optimize.linprog() の基本的な使い方

2. 最大化問題の扱い方
   → 目的関数の係数に-1を掛けて最小化問題に変換

3. 不等式「>=」の扱い方
   → 両辺に-1を掛けて「<=」に変換

4. 等式制約の追加方法
   → A_eq, b_eq パラメータを使用

5. 変数の範囲制約
   → bounds パラメータを使用

【SciPyの制限】
- 整数変数を扱えない
- 大規模問題には不向き
- 問題定義がやや面倒

次の章では、より柔軟なPuLPライブラリを学びます！
"""
print(summary)


if __name__ == "__main__":
    print("\n" + "=" * 60)
    print(" 第2章 完了！")
    print(" 次は chapter03_pulp.py を実行してください")
    print("=" * 60)
